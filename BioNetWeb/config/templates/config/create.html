{% extends "master.html" %}

{% block content %}
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
  
<style>
	
	.input-group .tooltiptext {
		display: inline-block;
	    visibility: hidden;
	    width: 80%;
	    background-color: #528B8B;
	    color: #fff;
	    text-align: center;
		border-radius: 6px;
		border: 2px #2F4F4F solid;
	    padding: 5px 5px;
	    position: absolute;
    	z-index: 100;
    	top: -15%;
    	left: 50%;
    	margin-left: -60px;
    	opacity: 0;
    	transition: opacity 0.3s;
	}
	
	.input-group:hover .tooltiptext {
	    visibility: visible;
	    opacity: 1;
	}
	
	.input-group-addon {
		min-width: 150px;
	}
	
	.input-group {
		padding-bottom: 5px;
	}
	
	span[name="checkbox"] {
		min-width: 0px;
	}
	
	input[type="checkbox"] {
		width: 30px;
		height: 30px;
	}
	
	.h-hover:hover {
		text-decoration: underline;
		cursor: pointer;
	}
	
	.preview {
		background-color: #E8ECEF;
		border-radius: 5px;
		font-size: 18px;
		padding-top: 10px;
		font-family: monospace;
		color: #000;
	}
	
	.preview pre {
		font-size: 18px;
		font-family: monospace;
	}
	
	.plabel {
		display: inline-block;
		padding-top: 20px;
	}

</style>

<div class="container-fluid">

	<div class="row">

	
	
	<div class="left col-md-4 col-sm-8">

		<h2 id="free-options">Free Options</h2>
		{% block observables %}
			{% include "config/mutate_input.html" with label="mutate" description="This option is used to identify a free parameter. It has three arguments. The first is a parameter identifier or parameter name. We recommend that parameter identifiers such as p__FREE__be used rather than parameter names such as p. See Section IV.B.3 in http://bionetfit.nau.edu/files/BioNetFit_User_Manual.pdf. The second argument is the 'mutation' rate (Q2). This quantity is a probability and therefore it must take values between 0 and 1. The third argument sets a range in which a factor will fall. This factor multiplies the old value of a parameter to obtain a new 'mutated' value of the parameter. The factor is chosen randomly. It is a uniform random deviate U that lies between 1 -arg3 and 1 + arg3, where arg3 is the user-specified value of the third argument. In other words, p_new = p_old*U = " %}
			{% for o in observables %}
				{% include "config/free_input.html" with label=o description="free observable"  %}
			{% endfor %}
		{% endblock %}
		
		<br>
		<br>
		
		<h2>General Options</h2>
		
		{% include "config/normal_input.html" with label="parallel_count" description="Number of models to run simultaneously when running on a personal computer. It is recommended that this is set to the number of CPU cores present in your machine. Default is 2."%}
		
		<div class="input-group">
		<span class="input-group-addon">max_walltime</span>
		<span class="tooltiptext">If a permutation is taking longer than maximum walltime, we will move on without it. Note: Many qsub systems will give your jobs lower priority as your walltime increases. Default is 01:00:00 (1 hour).</span>
		<input class="form-control" id="max-walltime-h" type="text" placeholder="HH">
		<span class="input-group-addon" style="min-width:0px;">:</span>
		<input class="form-control" id="max-walltime-m" type="text" placeholder="MM">
		<span class="input-group-addon" style="min-width:0px;">:</span>
		<input class="form-control" id="max-walltime-s" type="text" value="00">
		</div>
		
		<button class="dropdown-toggle btn-sm btn-secondary" data-toggle="collapse" data-target="#optional-general">Optional parameters</button>
		<div id="optional-general" class="collapse">
			{% include "config/normal_input.html" with label="seed" default="" description="Seed for BioNetFit's random number generator.  Comment this option out in order to use a different seed every time. Note: This seed only applies to BioNetFit's random number generator. It does not affect NFsim or BioNetGen. To give NFsim a seed, set seed=### in your simulation command or .rnf file. Default is no user-specified seed (i.e.,the seed is determined automatically)." %}
			{% include "config/normal_input.html" with label="max_retries" default="3" description="Sometimes a generation must be re-run because there were too many simulations which did not finish successfully.  This often happens because they hit the specified maximum walltime. max_retries is the number of times a generation will be run before BioNetFit gives up. Default is 3." %}
			{% include "config/bool_input.html" with label="make_plots" checked="Whether or not BioNetFit will output plots when results are ready. Default is 0." %}
			{% include "config/bool_input.html" with label="delete_old_files" checked="" description="BioNetFit results can use a lot of disk space.  Enabling this option will delete unnecessary files (.net, .bngl, .xml, .cdat, etc) as a run progresses. We note that if this option is turned on, BioNetFit may not be able to supply you with a model or .net file containing best-fit parameters at the end of the fitting run. " %}
		</div>
		
		<br>
		<br>
		
		<h2>Fitting Options</h2>
		{% include "config/normal_input.html" with label="max_generations" description="The maximum number of iterations orgenerations (Gmax). BioNetFit will execute this number of generations unless it quits earlier due to satisfaction of a stopping condition." %}
		{% include "config/normal_input.html" with label="permutations" description="The number of parameter value sets or population size or number of permutations (N). At each iteration, N simulation jobs will be performed." %}
		
		<button class="dropdown-toggle btn-sm btn-secondary" data-toggle="collapse" data-target="#optional-fitting">Optional parameters</button>
		<div id="optional-fitting" class="collapse">
			
			{% include "config/normal_input.html" with label="smoothing" default="1" description="Number of replicate simulation runs. The default value is 1. Multiple simulation runs are useful for smoothing the results of stochastic simulation. NB: Setting this parameter to 10 will increase the cost of simulation by an order of magnitude." %}
			{% include "config/normal_input.html" with label="objfunc" default="1" description="y(x)= measured value at condition x y[prime](x)= simulated value at condition x The objective function is a sum of terms over all x values. The terms can have the forms indicated below: 1:(y(x)-y[prime](x))[squared] 2: ((y(x)-y[prime](x))/y_SD(x))[squared] 3:((y(x)-y[prime](x))/y(x))[squared] 4:((y(x)-y[prime](x))/ybar)[squared] The objective function is selected by setting objfunc to one of the index values above. A setting of objfunc=1 indicates that the objective function is the sum-of-squares function (i.e., nonlinear least squares fitting). A setting of objfunc=2 indicates that the objective function is the chi-square function (i.e., weighted nonlinear least squares fitting). For this option, y values in .exp files must be accompanied by y_SD values. The default setting is 1." %}
			{% include "config/normal_input.html" with label="extra_weight" default="0" description="When selecting parents to breed, they are already weighted such that runs with better goodness-of-fit are more likely to be chosen. If you would like to weight the selection even more, increase this value. Note that more weight will make it less likely that different parents will be selected for breeding. Note: Values must be in the range 0-10. Default value is 0." %}
			{% include "config/normal_input.html" with label="swap_rate" default="0.5" description="This parameter sets the 'recombination' rate (Q1). It is a probability, so values must be between 0 and 1. The default settingis 0.5." %}
			{% include "config/normal_input.html" with label="max_parents" default="" description="This parameter sets the maximum number of 'parents' to be used in 'breeding.' By default, this parameter is equal to the population size (N)." %}
			{% include "config/normal_input.html" with label="keep_parents" default="0" description="This parameter determines the number of top-ranked parents (parameter value sets) that will be carried over to the next iteration. Default is 0." %}
			{% include "config/normal_input.html" with label="min_objfunc_value" default="0" description="If simulation results for a given parameter value set produce a function evaluation less than the value specified for this parameter, fitting will stop. The default is no stopping condition (i.e., this parameter is set to 0)." %}
			{% include "config/normal_input.html" with label="max_objfunc_value" default="" description="If simulation results for a given parameter value set produce a function evaluation greater than the value specified for this parameter, the parameter value set will not be used in 'breeding.' The default is no limit." %}
			{% include "config/normal_input.html" with label="first_gen_permutations" default="" description="Number of permutations to run in your first generation. This option allows you to start a fitting run with greater diversity. This setting will have the same value as permutations by default." %}
			{% include "config/normal_input.html" with label="log_transform_sim_data" default="" description="If this option is set to an integer value, all simulation output will be log transformed using the specified value as the transformation base. This transformation takes place prior to cost function evaluation." %}
			
			<!-- Options that aren't in the BioNetFit docs... -->
			{% include "config/normal_input.html" with label="population_size" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="fit_type" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="output_every" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="num_islands" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="mutate_type" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="cr" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="migration_frequency" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="num_to_migrate" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="inertia" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="cognitive" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="social" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="nmin" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="nmax" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="inertiaInit" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="inertiaFinal" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="abs_tolerance" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="rel_tolerance" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="mutate_qpso" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="topology" default="" description="There is no help information on this currently" %}
			{% include "config/normal_input.html" with label="pso_type" default="" description="There is no help information on this currently" %}
			{% include "config/bool_input.html" with label="synchronicity" checked="" description="There is no help information on this currently" %}
			{% include "config/bool_input.html" with label="enhanced_stop" checked="" description="There is no help information on this currently" %}
			{% include "config/bool_input.html" with label="enhanced_inertia" checked="" description="There is no help information on this currently" %}
			{% include "config/bool_input.html" with label="use_pipes" checked="" description="There is no help information on this currently" %}
			<!-- ------------------------------------------- -->
			
			{% include "config/bool_input.html" with label="divide_by_init" checked="" description="This option instructs BioNetFit, before cost function evaluation, to divide each model output by the first listed value of the output in the .gdat (or .scan) file, i.e., by the top numerical value in the .gdat (or .scan) file. This feature is useful when the first value listed is, for example, the basal steady-state value and the experimental data being used in fitting consists of fold-change measurements made relative to the basal steady state." %}
			{% include "config/bool_input.html" with label="stop_when_stalled" checked="checked" description="If this parameter is set to 1 (default setting) BioNetFit will stop the fitting run if new parameter value sets are identical to old parameter value sets after 'breeding.' This situation would only be expected to arise if the rate of 'mutation' is set to 0." %}
			{% include "config/bool_input.html" with label="standardize_sim_data" checked="" description="This option instructs BioNetFit to standardize simulation output to a mean of 0, using the following formula: y[x] = [y[x] minus ybar] / stdev[y] This standardization happens prior to cost function evaluation." %}
			{% include "config/bool_input.html" with label="standardize_exp_data" checked="" description="Similar to the above option, but in regards to experimental data (.exp file)." %}
			{% include "config/bool_input.html" with label="force_different_parents" checked="checked" description="This parameter determines whether a 'parent' is allowed to 'breed' with itself. If self-breeding is allowed, some parameter value sets may be unchanged from iteration to iteration. The default setting is 1." %}
		</div>
		
		<br>
		<br>
		
		<h2 class="dropdown-toggle h-hover" data-toggle="collapse" data-target="#cluster-options">Cluster Options</h2>
		<div id="cluster-options" class="collapse">
			
			{% include "config/normal_input.html" with label="cluster_command" default="" description="The user may specify the command to be used to submit a job for processing. However, in most cases, this is not necessary. BioNetFit is designed to automatically determine which command to use. Acceptable options are limited to 'sbatch' and 'qsub.'" %}
			{% include "config/normal_input.html" with label="cluster_software" default="" description="The user may specify the cluster platform being used. However, in most cases, this is not necessary. BioNetFit is designed to automatically determine which cluster platform is being used. Acceptable options are 'slurm,' 'torque,' and 'ge.'" %}
			{% include "config/normal_input.html" with label="pe_name" default="" description="The user may specify the parallel environment being used on the cluster. This is generally necessary on an SGE-based cluster. In general, this setting must be obtained from the cluster administrator; however, a typical setting is 'orte.'" %}
			{% include "config/normal_input.html" with label="queue_name" default="" description="The user may specify the work queue being used on the cluster. In general, this setting must be obtained from the cluster administrator; however, a typical setting is 'all.'" %}
			{% include "config/normal_input.html" with label="account_name" default="" description="The user may specify the account name being used on the cluster. This setting must be obtained from the cluster administrator. The account name is typically used to meter cluster usage." %}
			{% include "config/normal_input.html" with label="job_sleep" default="1" description="How many seconds to wait between sending off cluster jobs. This is useful because cluster schedulers sometimes fail to submit jobs properly when they are submitted in close succession. He default setting is 1." %}
			{% include "config/normal_input.html" with label="multisim" default="1" description="Number of simulations to run with each thread. The simulations will be run in serial. If your simulations finish quickly and the permutations option is set to a large value, you may want to set multisim to a value greater than 1, which will limit the number of jobs submitted. This will avoid the idle time between job submissions. The default setting is 1." %}
			{% include "config/bool_input.html" with label="use_cluster" checked="unchecked" description="This option should be set to 1 if you are running on a cluster. It is set to 0 by default." %}
			{% include "config/bool_input.html" with label="save_cluster_output" checked="unchecked" description="This option controls message output from the cluster job scheduler. Its default setting is 0 (no output). Setting this option to 1 may be useful for debugging and/or for reporting bugs or problems." %}
			{% include "config/bool_input.html" with label="run_job_from_worknode" checked="" description="Whether or not your cluster allows you to submit cluster jobs FROM working nodes. BioNetFit is designed to automatically determine which setting to use, so in most cases the user will not need to set this option. Set to 0 if you can only submit cluster jobs from the submission node (common on SGE clusters). Set to 1 if you can submit cluster jobs from work nodes (common on Torque/PBS and SLURM clusters)." %}
		</div>
		
		<br>
		<br>
		
		<h2 class="dropdown-toggle h-hover" data-toggle="collapse" data-target="#path-options">Path Options</h2>
		<div id="path-options" class="collapse">
			{% include "config/normal_input.html" with label="model" description="Absolute path to your model file" %}
			{% include "config/normal_input.html" with label="exp_file" description="Absolute path to your .exp file. You may specify this option multiple times for multiple .exp files" %}
			{% include "config/normal_input.html" with label="output_dir" description="Absolute path where you want your output to go" %}
			{% include "config/normal_input.html" with label="bng_command" description="Absolute path to your BioNetGen executable" %}
			{% include "config/normal_input.html" with label="job_name" description="This is the job name, and name of the directory that will contain your results." %}
		</div>
		
		<br>
		<br>
		
		<h2 class="dropdown-toggle h-hover" data-toggle="collapse" data-target="#display-options">Display Options</h2>
		<div id="display-options" class="collapse">
			{% include "config/normal_input.html" with label="verbosity" description="How much information to display about run progress.  0 = no information, 4 = way more information than you are likely to need.  1 or 2 is recommended. Default is 1." %}
			{% include "config/bool_input.html" with label="ask_create" description="Whether or not to ask when creating a new output directory. Default is 1." %}
			{% include "config/bool_input.html" with label="ask_overwrite" description="Whether or not to ask when overwriting existing job output. Default is 1. Warning: Turning this off can be dangerous!" %}
			{% include "config/bool_input.html" with label="show_welcome_message" description="Whether or not to show a welcome message when running BioNetFit. Default is 1." %}
		</div>
		
		<br>
		<br>
		<br>
		<!--<form method="POST" enctype="multipart/form-data">{% csrf_token %}-->
		<div id="buttons"style="float: left">
			<input id="download" type="submit" value="Download" name="download">
			<input id="monsoon" type="submit" value="Monsoon" name="monsoon">
		</div>
		<!--</form>-->
	</div> <!-- left column -->
	
	
	
	
	<div class="col-md-2"></div>
	
	
	
	<!-----------------------LIVE PREVIEW--------------------------->
	
	<div class="col-md-6 col-sm-12">
	
		<h2>Live Preview</h2>
	
		<div class="preview container-fluid">
	
		<pre id="free-options-p">

####################
### Free Options ###
####################</pre>
		{% include "config/mutate_label.html" with label="mutate" %}
		{% for o in observables %}
			{% include "config/free_label.html" with label=o %}
		{% endfor %}

		<pre id="general-options-p">

#######################
### General Options ###
#######################</pre>		

		{% include "config/label.html" with label="parallel_count" %}
		{% include "config/label.html" with label="seed" %}
		{% include "config/label.html" with label="max_retries" %}
		{% include "config/label.html" with label="make_plots" %}
		{% include "config/label.html" with label="delete_old_files" %}

		<pre id="fitting-options-p">

#######################
### Fitting Options ###
#######################</pre>		

		{% include "config/label.html" with label="max_generations" %}
		{% include "config/label.html" with label="permutations" %}
		{% include "config/label.html" with label="smoothing" %}
		{% include "config/label.html" with label="objfunc" %}
		{% include "config/label.html" with label="extra_weight" %}
		{% include "config/label.html" with label="swap_rate" %}
		{% include "config/label.html" with label="max_parents" %}
		{% include "config/label.html" with label="keep_parents" %}
		{% include "config/label.html" with label="min_objfunc_value" %}
		{% include "config/label.html" with label="max_objfunc_value" %}
		{% include "config/label.html" with label="first_gen_permutations" %}
		{% include "config/label.html" with label="log_transform_sim_data" %}
		{% include "config/label.html" with label="divide_by_init" %}
		{% include "config/label.html" with label="stop_when_stalled" %}
		{% include "config/label.html" with label="standardize_sim_data" %}
		{% include "config/label.html" with label="standardize_exp_data" %}
		{% include "config/label.html" with label="force_different_parents" %}

		<!-- Not in docs -->
		{% include "config/label.html" with label="population_size" %}
		{% include "config/label.html" with label="fit_type" %}
		{% include "config/label.html" with label="synchronicity" %}
		{% include "config/label.html" with label="output_every" %}
		{% include "config/label.html" with label="num_islands" %}
		{% include "config/label.html" with label="mutate_type" %}
		{% include "config/label.html" with label="cr" %}
		{% include "config/label.html" with label="migration_frequency" %}
		{% include "config/label.html" with label="num_to_migrate" %}
		{% include "config/label.html" with label="inertia" %}
		{% include "config/label.html" with label="cognitive" %}
		{% include "config/label.html" with label="social" %}
		{% include "config/label.html" with label="nmin" %}
		{% include "config/label.html" with label="nmax" %}
		{% include "config/label.html" with label="inertiaInit" %}
		{% include "config/label.html" with label="inertiaFinal" %}
		{% include "config/label.html" with label="abs_tolerance" %}
		{% include "config/label.html" with label="rel_tolerance" %}
		{% include "config/label.html" with label="mutate_qpso" %}
		{% include "config/label.html" with label="topology" %}
		{% include "config/label.html" with label="pso_type" %}
		{% include "config/label.html" with label="enhanced_stop" %}
		{% include "config/label.html" with label="enhanced_inertia" %}
		{% include "config/label.html" with label="use_pipes" %}
		<!-- ----------- -->
		
		<pre id="cluster-options-p">

#######################
### Cluster Options ###
#######################</pre>	

		{% include "config/label.html" with label="cluster_command" %}
		{% include "config/label.html" with label="cluster_software" %}
		{% include "config/label.html" with label="pe_name" %}
		{% include "config/label.html" with label="queue_name" %}
		{% include "config/label.html" with label="account_name" %}
		{% include "config/label.html" with label="job_sleep" %}
		{% include "config/label.html" with label="multisim" %}
		{% include "config/label.html" with label="use_cluster" %}
		{% include "config/label.html" with label="save_cluster_output" %}
		{% include "config/label.html" with label="run_job_from_worknode" %}


		<pre id="path-options-p">

####################
### Path Options ###
####################</pre>

		{% include "config/label.html" with label="model" %}
		{% include "config/label.html" with label="exp_file" %}
		{% include "config/label.html" with label="output_dir" %}
		{% include "config/label.html" with label="bng_command" %}
		{% include "config/label.html" with label="job_name" %}


		<pre id="display-options-p">

#######################
### Display Options ###
#######################</pre>		
		
		{% include "config/label.html" with label="verbosity" %}
		{% include "config/label.html" with label="ask_create" %}
		{% include "config/label.html" with label="ask_overwrite" %}
		{% include "config/label.html" with label="show_welcome_message" %}
		
		
		
		</div>
		
	</div> <!-- right column -->
	
	
	
	
	
	</div> <!-- row -->

</div> <!-- container-fluid -->


<script>

	// Normal input live preview
	$(".normal").keyup(function () {
		var oldId = $(this).attr("id");
		var newId = oldId + "-p";
		var inpt = $(this).val();
		if (inpt == "") {
			$("#" + newId).css("display", "none");
		} else {
			$("#" + newId).css("display", "block");
			$("#" + newId).html(oldId + "=" + inpt);
		}
		
	});
	
	// Bool input live preview
	$(".bool").change(function () {
		var oldId = $(this).attr("id");
		var newId = oldId + "-p";
		$("#" + newId).css("display", "block");
		if(this.checked) {
			$("#" + newId).html(oldId + "=1");
		} else {
			$("#" + newId).html(oldId + "=0");
		}
	});
	
	// Free input live preview
	$(".free").keyup(function () {
		var oldId = $(this).attr("id");
		
		var splitId = oldId.split("-");
		
		if (splitId[1] == "lower") {
			var lower = $(this).val();
			var upper = document.getElementById(splitId[0] + "-upper").value;
		} else {
			var lower = document.getElementById(splitId[0] + "-lower").value;
			var upper = $(this).val();
		}
				
		var newId = splitId[0] + "-p";
		if (lower == "" && upper == "") {
			$("#" + newId).css("display", "none");
		} else {
			$("#" + newId).css("display", "block");
			$("#" + newId).html("loguniform_var=" + splitId[0] + "\t" + lower + "\t" + upper);
		}
	});
	
	$(function() {
		$("#monsoon").click(function() {
			var data = "";
			var mutateFields = document.getElementsByClassName("mutate");
			var freeFields = document.getElementsByClassName("free");
			var normalFields = document.getElementsByClassName("normal");
			var boolFields = document.getElementsByClassName("bool");

			for (var i = 0; i < mutateFields.length; i+=2) {
				var name = mutateFields[i].id.split("-")[0];
				data += "mutate=default" + " " + mutateFields[i].value + " " + mutateFields[i+1].value + "\n";
			}
			
			for (var i = 0; i < freeFields.length; i+=2) {
				var name = freeFields[i].id.split("-")[0];
				data += "loguniform_var=" + name + " " + freeFields[i].value + " " + freeFields[i+1].value + "\n";
			}
			
			for (var i = 0; i < normalFields.length; i++) {
				var parent = document.getElementById(normalFields[i].id + "-p");
				if (parent.style.display != "none") {
					data += normalFields[i].id + "=" + normalFields[i].value + "\n"
				}
			}
			
			for (var i = 0; i < boolFields.length; i++) {
				var parent = document.getElementById(boolFields[i].id + "-p");
				if (parent.style.display != "none") {
					var checked = boolFields[i].checked ? "1" : "0";
					data += boolFields[i].id + "=" + checked + "\n";
				}
			}
			
			
			$.ajax({type: "POST",
					url: "/user",
					data: {conf: data,
						   bngl: `{{ bngl }}`,
						   exp: `{{ exp }}`,
						   bnglName: "{{ bngl_name }}",
						   expName: "{{ exp_name }}",
						   csrfmiddlewaretoken: '{{ csrf_token }}'},
					success: function() 
						{
							location.href="user"
						}
					});
					
			
		});
	});
</script>
{% endblock %}
